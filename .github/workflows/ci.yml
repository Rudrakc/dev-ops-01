# =============================================================================
# CI Pipeline - Continuous Integration Workflow
# =============================================================================
# This workflow runs on every push to master and pull requests
# It includes: Linting, SAST, SCA, Unit Tests, Build, Docker, and Security Scans
# =============================================================================

name: CI Pipeline

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

env:
  # Docker image name - will be pushed to DockerHub
  IMAGE_NAME: devops-todo-api
  NODE_VERSION: '18'

jobs:
  # ===========================================================================
  # Stage 1: Code Quality & Security Analysis
  # ===========================================================================
  lint-and-test:
    name: Lint, Test & Build
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------------------------------------
      # Step 1: Checkout source code
      # -----------------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Step 2: Setup Node.js environment
      # -----------------------------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # -----------------------------------------------------------------------
      # Step 3: Install dependencies
      # -----------------------------------------------------------------------
      - name: Install dependencies
        run: npm ci

      # -----------------------------------------------------------------------
      # Step 4: Linting - Check code style with ESLint
      # -----------------------------------------------------------------------
      - name: Run ESLint
        run: npm run lint

      # -----------------------------------------------------------------------
      # Step 5: SCA - Software Composition Analysis (Check for vulnerable dependencies)
      # -----------------------------------------------------------------------
      - name: Run npm audit (SCA)
        run: npm audit --audit-level=high
        continue-on-error: true

      # -----------------------------------------------------------------------
      # Step 6: Unit Tests with Coverage
      # -----------------------------------------------------------------------
      - name: Run unit tests with coverage
        run: npm run test:ci

      # -----------------------------------------------------------------------
      # Step 7: Build TypeScript
      # -----------------------------------------------------------------------
      - name: Build TypeScript
        run: npm run build

      # -----------------------------------------------------------------------
      # Step 8: Upload coverage report as artifact
      # -----------------------------------------------------------------------
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

  # ===========================================================================
  # Stage 2: SAST - Static Application Security Testing with CodeQL
  # ===========================================================================
  codeql-analysis:
    name: CodeQL Security Analysis (SAST)
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript
          # Optional: specify additional queries
          # queries: security-extended

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript-typescript"

  # ===========================================================================
  # Stage 3: Docker Build, Scan & Push
  # ===========================================================================
  docker:
    name: Docker Build, Scan & Push
    runs-on: ubuntu-latest
    needs: [lint-and-test]

    steps:
      # -----------------------------------------------------------------------
      # Step 1: Checkout source code
      # -----------------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Step 2: Set up Docker Buildx (for advanced build features)
      # -----------------------------------------------------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # -----------------------------------------------------------------------
      # Step 3: Login to DockerHub
      # -----------------------------------------------------------------------
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # -----------------------------------------------------------------------
      # Step 4: Extract metadata for Docker
      # -----------------------------------------------------------------------
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      # -----------------------------------------------------------------------
      # Step 5: Build Docker image (without pushing yet)
      # -----------------------------------------------------------------------
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # -----------------------------------------------------------------------
      # Step 6: Trivy Security Scan - Scan image for vulnerabilities
      # -----------------------------------------------------------------------
      - name: Scan Docker image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:test
          format: 'table'
          exit-code: '0'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      # -----------------------------------------------------------------------
      # Step 7: Container Test - Run container and verify it works
      # -----------------------------------------------------------------------
      - name: Run container test
        run: |
          # Start the container in detached mode
          docker run -d --name test-container -p 3000:3000 \
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:test

          # Wait for the container to be ready
          echo "Waiting for container to start..."
          sleep 10

          # Test the health endpoint
          echo "Testing health endpoint..."
          curl --fail --retry 5 --retry-delay 2 http://localhost:3000/api/health || exit 1

          # Test the main API endpoint
          echo "Testing API endpoint..."
          curl --fail http://localhost:3000/api/todos || exit 1

          echo "Container tests passed!"

          # Cleanup
          docker stop test-container
          docker rm test-container

      # -----------------------------------------------------------------------
      # Step 8: Push Docker image to DockerHub
      # -----------------------------------------------------------------------
      - name: Push Docker image to DockerHub
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
